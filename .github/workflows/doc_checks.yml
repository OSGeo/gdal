name: Docs

on:
    push:
        branches-ignore:
            - 'backport**'
            - 'dependabot**'
    pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docs:
    name: Documentation checks

    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    container: ubuntu:24.04

    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    - name: Setup environment
      shell: bash -l {0}
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
          apt update
          apt install -y g++ cmake doxygen enchant-2 python3 python3-dev python3-pip python3-venv libproj-dev swig libsqlite3-dev
          python3 -m venv create doc_env
          . doc_env/bin/activate
          python3 -m pip install -r doc/requirements.txt
          python3 -m pip install setuptools
          python3 -m pip install pytest
          python3 -m pip install docstub
          echo PATH=$PATH >> $GITHUB_ENV

    - name: Build GDAL
      shell: bash -l {0}
      run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_APPS=ON \
            -DBUILD_DOCS=ON \
            -DBUILD_TESTING=ON \
            -DDOXYGEN_FAIL_ON_WARNINGS=ON \
            -DGDAL_BUILD_OPTIONAL_DRIVERS=OFF \
            -DOGR_BUILD_OPTIONAL_DRIVERS=OFF \
            -DGDAL_ENABLE_DRIVER_GTI=ON \
            -DOGR_ENABLE_DRIVER_GPKG=ON \
            -DOGR_ENABLE_DRIVER_OPENFILEGDB=ON
          cmake --build . -j$(nproc)

    - name: Print versions
      shell: bash -l {0}
      run: |
          which python3
          python3 --version
          sphinx-build --version
          python3 -m pip list --not-required --format=columns

    - name: Lint .rst files
      shell: bash -l {0}
      run: |
        if find . -name '*.rst' | xargs grep -P '\t'; then echo 'Tabs are bad, please use four spaces in .rst files.'; false; fi
        if find . -name '*.rst' | xargs grep "\.\.versionadded"; then echo 'Wrong annotation. Should be .. versionadded'; false; fi
        if find . -name '*.rst' | xargs grep "\.\.note"; then echo 'Wrong annotation. Should be .. note'; false; fi
        if find . -name '*.rst' | xargs grep "\.\.warning"; then echo 'Wrong annotation. Should be .. warning'; false; fi
        if find . -name '*.rst' | xargs grep "\.\.codeblock"; then echo 'Wrong annotation. Should be .. codeblock'; false; fi
      working-directory: ./doc

    - name: Doxygen
      shell: bash -l {0}
      run: |
        cmake --build . --target doxygen_xml
      working-directory: build

    - name: Test documentation examples
      shell: bash -l {0}
      run: |
          ctest -V -R doc-examples --output-on-failure
      working-directory: build

    - name: Spelling
      shell: bash -l {0}
      run: |
        python3 -c 'from osgeo import gdal'
        ctest -V -R spelling --output-on-failure
      working-directory: build

    - name: Docstub annotations
      shell: bash -l {0}
      run: |
        ctest -V -R docstub-annotations --output-on-failure
      working-directory: build

    - name: Sphinx man page documentation
      shell: bash -l {0}
      run: |
        cmake --build . --target man
      working-directory: build

    - name: Upload man pages
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: manpages
        path: build/doc/build/man/

    # ReadTheDocs pull requests do not build PDF, but we can break it though,
    # so build it here
    - name: PDF build
      shell: bash -l {0}
      run: |
        apt install -y dvipng latexmk texlive-latex-base \
                       texlive-latex-extra git latex-cjk-all texlive-lang-all tex-gyre
        cmake --build . --target latexpdf
      working-directory: build

    - name: Upload PDF
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: gdal.pdf
        path: build/doc/build/latex/gdal.pdf
