.. _gdal_raster_blend:

================================================================================
``gdal raster blend``
================================================================================

.. versionadded:: 3.12

.. only:: html

    Blend/compose two raster datasets

.. Index:: gdal raster blend

Synopsis
--------

.. program-output:: gdal raster blend --help-doc

Description
-----------

:program:`gdal raster blend` allows the user to compose two raster datasets
(of the same size) using a selected blending operation and an opacity setting.

This can be used for example to colorize a hillshade raster generated by
:ref:`gdal_raster_hillshade` with an hypsometric rendering of a DEM generated
by :ref:`gdal_raster_color_map` when using the ``hsv-value`` blending operator.

The more standard ``src-over`` blending operator, which does "alpha blending"
is also available.

This subcommand is also available as a potential step of :ref:`gdal_raster_pipeline`

.. GDALG output (on-the-fly / streamed dataset)
.. --------------------------------------------

.. include:: gdal_cli_include/gdalg_raster_compatible.rst

Program-Specific Options
------------------------

.. option:: --input <INPUT>

   Name of the dataset into which to blend the overlay dataset. Required.

   When using the ``hsv-value`` blending operator, this must be a three-band or four-band Byte raster.

.. option:: --opacity <OPACITY>

    Opacity to use when blending the overlay dataset, as a percentage
    between 0 and 100. 0 means that the overlay dataset is considered fully
    transparent. 100 means that the overlay dataset is blended at the maximum
    of its alpha channel.
    Defaults to 100.

.. option:: --operator src-over|hsv-value|multiply|screen|overlay|hard-light|lighten|darken

    Select the blending operator, which defines how the overlay dataset is
    blended into the input dataset. Defaults to ``src-over``.

    - ``src-over`` performs standard alpha blending, by compositing the overlay
      dataset over the input dataset.

      Given :math:`overlay_{C}` the value of one of the red, green or blue
      component of the overlay dataset,
      :math:`overlay_{A}` the value of the alpha component of the overlay dataset,
      :math:`input_{C}` the value of the corresponding component of the input dataset,
      :math:`input_{A}` the value of the alpha component of the input dataset
      and :math:`opacity`, the value of :option:`--opacity`, the resulting
      component :math:`output_{C}` is (all values normalized to [0,1] range):

      .. math::

          output_{C} * output_{A} = (overlay_{C} * overlay_{A} * opacity) + (input_{C} * input_{A} * (1 - overlay_{A} * opacity))

      with

      .. math::

          output_{A} = (overlay_{A} * opacity) + (input_{A} * (1 - overlay_{A} * opacity))

    - ``hsv-value`` creates a color with the value of the overlay and the hue
      and saturation of the input. It performs the following steps:

      * read the RGB (Red,Green,Blue) components of the input dataset

      * transform the RGB components into the HSV (Hue,Saturation,Value) color space

      * compute the output value :math:`output_{V}`, from
        :math:`input_{V}` the input value computed in the previous step,
        :math:`overlay_{V}` the overlay value,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset
        and :math:`opacity`, the value of :option:`--opacity` (all values normalized to [0,1] range):

        .. math::

            output_{V} = (overlay_{V} * overlay_{A} * opacity) + (input_{V} * (1 - overlay_{A} * opacity))

        If the overlay dataset is a RGB/RGBA dataset, :math:`overlay_{V}` is
        :math:`max(overlay_{R},overlay_{G},overlay_{B})`.

      * transform back (Hue,Saturation,:math:`output_{V}`) to RGB.

      If the the alpha channel of the input dataset is present, it is preserved unchanged.

    - ``multiply`` multiplies the input and overlay colors.
      The resulting color is always at least as dark as either of the two
      constituent colors.

      .. note::
        - all values are normalized to [0,1] range.
        - default alpha value is set to 1.0 if no alpha channel is present.

      Given :math:`overlay_{C}` the value of one of the red, green or blue
      component of the overlay dataset,
      :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
      :math:`input_{C}` the value of the corresponding component of the input dataset,
      :math:`input_{A}` the value of the alpha component of the input dataset
      and :math:`opacity`, the value of :option:`--opacity`, the resulting
      component :math:`output_{C}` is:

        .. math::

            output_{C} = overlay_{C} * input_{C} + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

      Alpha channel is computed as:

        .. math::

            output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}

    - ``screen`` The overlay and input are complemented and then multiplied. The resultant color is always at least as light as either of the two constituent colors. Screening any color with white produces white. Screening any color with black leaves the original color unchanged.

        .. note::
            - all values are normalized to [0,1] range.
            - default alpha value is set to 1.0 if no alpha channel is present.

        Given :math:`overlay_{C}` the value of one of the red, green or blue
        component of the overlay dataset,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
        :math:`input_{C}` the value of the corresponding component of the input dataset,
        :math:`input_{A}` the value of the alpha component of the input dataset
        and :math:`opacity`, the value of :option:`--opacity`, the resulting
        component :math:`output_{C}` is:

        .. math::

            output_{C} = overlay_{C} + input_{C} + overlay_{C} * input_{C}


        Alpha channel is computed as:

            .. math::

                output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}

    - ``overlay`` Overlay combines Multiply and Screen blend modes, at half strength. The parts of the overlay layer where the input layer is light become lighter, the parts where the input layer is dark become darker. Areas where the overlay layer are mid grey are unaffected.

        .. note::
            - all values are normalized to [0,1] range.
            - default alpha value is set to 1.0 if no alpha channel is present.

        Given :math:`overlay_{C}` the value of one of the red, green or blue
        component of the overlay dataset,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
        :math:`input_{C}` the value of the corresponding component of the input dataset,
        :math:`input_{A}` the value of the alpha component of the input dataset
        and :math:`opacity`, the value of :option:`--opacity`, the resulting
        component :math:`output_{C}` is:

        If the input component is less than 0.5 (dark):

        .. math::

            output_{C} = 2 * overlay_{C} * input_{C} + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        If the input component is greater than or equal to 0.5 (light):

        .. math::

            output_{C} = overlay_{A} *  input_{A} - 2 * (input_{A} - input_{C}) * (overlay_{A} - overlay_{C}) + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        Alpha channel is computed as:

            .. math::

                output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}

    - ``hard-light`` The overlay is used to either multiply or screen the input, depending on the overlay color value. If the overlay color value is lighter than 50% gray, the input is screened, otherwise it is multiplied. This is useful for adding highlights or shadows to an image. The implementation is the same of ``overlay`` but with the roles of input and overlay swapped.

        .. note::
            - all values are normalized to [0,1] range.
            - default alpha value is set to 1.0 if no alpha channel is present.

        Given :math:`overlay_{C}` the value of one of the red, green or blue
        component of the overlay dataset,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
        :math:`input_{C}` the value of the corresponding component of the input dataset,
        :math:`input_{A}` the value of the alpha component of the input dataset
        and :math:`opacity`, the value of :option:`--opacity`, the resulting
        component :math:`output_{C}` is:

        If the overlay component is less than 0.5 (dark):

        .. math::

            output_{C} = overlay_{A} *  input_{A} - 2 * (input_{A} - input_{C}) * (overlay_{A} - overlay_{C}) + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        If the overlay component is greater than or equal to 0.5 (light):

        .. math::

            output_{C} = 2 * overlay_{C} * input_{C} + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        Alpha channel is computed as:

            .. math::

                output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}

    - ``darken`` Creates a image that retains the smallest components of the overlay and input pixels. If the overlay pixel has the components r1, g1, and b1, and the input pixel has r2, g2, b2, the resultant pixel is [min(r1,r2), min(g1,g2), min(b1,b2)]

        .. note::
            - all values are normalized to [0,1] range.
            - default alpha value is set to 1.0 if no alpha channel is present.

        Given :math:`overlay_{C}` the value of one of the red, green or blue
        component of the overlay dataset,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
        :math:`input_{C}` the value of the corresponding component of the input dataset,
        :math:`input_{A}` the value of the alpha component of the input dataset
        and :math:`opacity`, the value of :option:`--opacity`, the resulting
        component :math:`output_{C}` is:

        .. math::

            output_{C} = min(overlay_{C}, input_{C}) + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        Alpha channel is computed as:

            .. math::

                output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}

    - ``lighten`` Lighten has the opposite action of Darken. It selects the maximum of each component from the overlay and input pixels. If the overlay pixel has the components r1, g1, and b1, and the input pixel has r2, g2, b2, the resultant pixel is [max(r1,r2), max(g1,g2), max(b1,b2)]

        .. note::
            - all values are normalized to [0,1] range.
            - default alpha value is set to 1.0 if no alpha channel is present.

        Given :math:`overlay_{C}` the value of one of the red, green or blue
        component of the overlay dataset,
        :math:`overlay_{A}` the value of the alpha component of the overlay dataset premultiplied by :option:`--opacity`,
        :math:`input_{C}` the value of the corresponding component of the input dataset,
        :math:`input_{A}` the value of the alpha component of the input dataset
        and :math:`opacity`, the value of :option:`--opacity`, the resulting
        component :math:`output_{C}` is:

        .. math::

            output_{C} = max(overlay_{C}, input_{C}) + input_{C} * (1 - overlay_{A}) + overlay_{C} * (1 - input_{A})

        Alpha channel is computed as:

            .. math::

                output_{A} = overlay_{A} + input_{A} - overlay_{A} * input_{A}



.. option:: --overlay <OVERLAY>

   Name of the overlay dataset. Required


Standard Options
----------------

.. collapse:: Details

    .. include:: gdal_options/append_raster.rst

    .. include:: gdal_options/co.rst

    .. include:: gdal_options/if.rst

    .. include:: gdal_options/oo.rst

    .. include:: gdal_options/of_raster_create_copy.rst

    .. include:: gdal_options/overwrite.rst


Examples
--------

.. example::
   :title: Alpha blending of two datasets using 75% opacity for the overlay dataset.

   .. code-block:: bash

        $ gdal raster blend --opacity 75 source.tif overlay.tif out.tif

.. example::
   :title: Combine a hillshade and a hypsometric rendering of a DEM into a colorized hillshade.

   .. image:: ../../images/programs/gdal_raster_blend/hillshade.jpg
       :alt:   Hillshade rendering of a DEM

   .. image:: ../../images/programs/gdal_raster_blend/hypsometric.jpg
       :alt:   Hypsometric rendering of a DEM

   .. code-block:: bash

        $ gdal raster blend --overlay=hillshade.tif --operator=hsv-value \
                            hypsometric.tif hypsometric_combined_with_hillshade.tif


   .. image:: ../../images/programs/gdal_raster_blend/hypsometric_combined_with_hillshade.jpg
       :alt:   Colorized hillshade


.. below is an allow-list for spelling checker.

.. spelling:word-list::
    RGB
    RGBA
    HSV
